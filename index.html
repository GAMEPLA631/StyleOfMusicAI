<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Musical Universe | Lyric Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- GLASSMORPHISM STYLES START --- */
        body {
            font-family: 'Inter', sans-serif;
            /* Dark gradient background for Glassmorphism effect */
            background: linear-gradient(135deg, #1f013d 0%, #0c0823 100%);
            color: #e2e8f0; /* Light text for dark background */
        }
        
        /* Glass effect for containers */
        .container-section {
            background-color: rgba(255, 255, 255, 0.1); /* Semi-transparent white */
            backdrop-filter: blur(10px); /* Main blur effect */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Soft light border */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Stronger shadow */
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* Header and Footer - also glass-styled */
        header {
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        footer {
            background-color: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hero Block - subtle color tint in glass style */
        .bg-indigo-50\/50 {
            background-color: rgba(109, 40, 217, 0.15); 
        }

        /* Text and input fields for dark glass style */
        .text-gray-900, .text-gray-800, .text-gray-700, .text-gray-600, label {
            color: #e2e8f0 !important; /* All important text light */
        }
        
        /* Inputs and Select */
        #genre-select, #topic-input {
            background-color: rgba(0, 0, 0, 0.2); /* Darker background for better readability */
            border-color: rgba(255, 255, 255, 0.3);
            color: #ffffff;
        }
        
        /* AI Result Box */
        .ai-result-box {
            min-height: 250px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
            background-color: rgba(0, 0, 0, 0.3); /* Darkest glass */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 0.9rem;
        }

        /* Action colors for better visibility on dark background */
        .text-indigo-600 { color: #6366f1 !important; }
        .text-indigo-500 { color: #818cf8 !important; }
        .button-primary { background-color: #6366f1; } /* Lighter blue */
        .button-primary:hover { background-color: #4f46e5; }
        .loading-spinner { border-top-color: #6366f1; }
        .focus-ring-blue:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); }
        
        /* Tags */
        #genre-list-display span {
            background-color: rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
            border: 1px solid rgba(99, 102, 241, 0.4);
        }

        /* --- GLASSMORPHISM STYLES END --- */

        .loading-spinner {
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltip style for copy confirmation */
        .copy-tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Copy Confirmation Tooltip (Not visible by default) -->
    <div id="copy-confirmation" class="copy-tooltip">
        Copied to clipboard!
    </div>

    <!-- Header / Navigation Bar (Glassmorphism Style) -->
    <header class="shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-600 tracking-tight">
                <span class="inline-flex items-center">
                    <i data-lucide="music" class="w-7 h-7 mr-2"></i>
                    The Musical Universe
                </span>
            </h1>
            <nav class="hidden md:flex space-x-6">
                <a href="#generator" class="text-gray-300 hover:text-indigo-400 font-medium transition duration-150">Generator</a>
                <a href="#genres" class="text-gray-300 hover:text-indigo-400 font-medium transition duration-150">Genres</a>
            </nav>
            <button class="md:hidden text-gray-300 hover:text-indigo-400">
                 <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Hero / Intro Block (Glassmorphism Style) -->
        <div class="container-section text-center p-8 sm:p-12 bg-indigo-50/50">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-white mb-4">
                Your Lyric, Your Genre, Your Song.
            </h2>
            <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto">
                Select one of 170+ musical styles and let the AI generate a **long** and structurally detailed lyric for your new track!
            </p>
            <a href="#generator" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white button-primary hover:scale-105 transition duration-200">
                Start Generating <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
            </a>
        </div>

        <!-- Lyric Generator Section (Glassmorphism Style) -->
        <section id="generator" class="container-section">
            <h3 class="text-3xl font-bold text-white mb-6 border-b border-gray-600 pb-3 flex items-center">
                <i data-lucide="pen-tool" class="w-6 h-6 mr-3 text-indigo-500"></i>
                Lyric Generator
            </h3>

            <!-- Input Form -->
            <div class="space-y-6">
                <!-- Genre Selector -->
                <div>
                    <label for="genre-select" class="block text-sm font-medium mb-2">1. Select Musical Genre (170+ options)</label>
                    <select id="genre-select" class="w-full rounded-lg shadow-sm py-3 px-4 focus-ring-blue focus:border-blue-500 transition duration-150">
                        <option value="" disabled selected>Select the genre that best captures your vision...</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <!-- User Prompt / Topic -->
                <div>
                    <label for="topic-input" class="block text-sm font-medium mb-2">2. What is the topic of your song and what language should the lyric be in?</label>
                    <textarea id="topic-input" rows="3" placeholder="E.g.: Topic: Revenge in a cyberpunk city. Language: English. (or Slovak, German, etc.)" class="w-full rounded-lg shadow-sm py-3 px-4 focus-ring-blue focus:border-blue-500 transition duration-150" maxlength="300"></textarea>
                    <p class="text-xs text-gray-400 mt-1">Maximum 300 characters. The AI will generate the lyric in the language you specify. **Output will be unformatted and use the long structure (Intro, 3x Verse, 2x Chorus, Bridge, Outro).**</p>
                </div>

                <!-- Generate Button -->
                <button id="generate-button" onclick="generateLyrics()" class="w-full button-primary text-white font-bold py-3 rounded-full shadow-lg flex items-center justify-center focus-ring-blue" disabled>
                    <i data-lucide="send" id="send-icon" class="w-5 h-5 mr-2"></i>
                    <span id="button-text">Generate Lyric</span>
                    <div id="loading-spinner" class="loading-spinner hidden w-5 h-5 border-2 border-t-2 rounded-full ml-2"></div>
                </button>
            </div>
        </section>

        <!-- AI Result Section (Glassmorphism Style) -->
        <section class="container-section mt-8">
            <h3 class="text-3xl font-bold text-white mb-6 border-b border-gray-600 pb-3 flex items-center">
                <i data-lucide="file-text" class="w-6 h-6 mr-3 text-indigo-500"></i>
                Generated Song Lyric
            </h3>

            <div class="flex justify-end mb-4">
                <button id="copy-button" onclick="copyResult()" class="hidden text-sm font-medium text-white bg-green-600 hover:bg-green-700 py-2 px-4 rounded-full shadow-md transition duration-150">
                    <i data-lucide="copy" class="w-4 h-4 inline-block mr-1"></i> Copy Full Lyric
                </button>
            </div>

            <div id="result-container" class="ai-result-box p-6 rounded-lg overflow-auto">
                <p class="text-gray-400 italic">Your generated lyric will appear here after clicking the "Generate Lyric" button.</p>
            </div>
            
            <div id="source-container" class="mt-4 text-xs text-gray-400 hidden">
                <p class="font-bold mb-1">Sources (for fact-checking, if used):</p>
                <ul id="source-list" class="list-disc pl-5 space-y-1">
                </ul>
            </div>
        </section>

        <!-- Genre List Section (Glassmorphism Style) -->
        <section id="genres" class="container-section mt-8">
             <h3 class="text-3xl font-bold text-white mb-6 border-b border-gray-600 pb-3 flex items-center">
                <i data-lucide="tag" class="w-6 h-6 mr-3 text-indigo-500"></i>
                Genre and Style Catalog (170+)
            </h3>
            <p class="text-gray-400 mb-4">Click any tag to copy its name to the clipboard for easy use:</p>

            <div id="genre-list-display" class="flex flex-wrap gap-2 text-sm">
                <!-- Tags will be populated by JavaScript -->
            </div>
        </section>

    </main>

    <!-- Footer (Glassmorphism Style) -->
    <footer class="text-white py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 The Musical Universe | Powered by AI</p>
            <p class="text-xs text-gray-400 mt-2">Created for maximum creative output. No Folk or Ancient Styles.</p>
        </div>
    </footer>


    <script>
        // --- 1. CONFIGURATION AND DATA ---

        // API Configuration
        const apiKey = "AIzaSyD3mxzbdINvR0WMBXqBhQpp5kkihcXtRTY";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // Extensive list of genres/styles (170+) - TRANSLATED
        const genres = [
            "Bass Boosted - Aggressive", "Electro House - Max Bass", "Drum & Bass - Heavy", "Dubstep - Brutal", "Hardstyle - Hardcore Kick",
            "Trap - High Energy", "Grime - Dark & Gritty", "Drill - Aggressive Flow", "Future Bass - Melodic Bass", "Glitch Hop - Broken Rhythm",
            "Psytrance - Fast Tempo", "Techno - Minimalist & Deep", "Trance - Euphoric Uplifting", "House - Classic Deep", "Progressive House - Melodic",
            "Ambient - Relaxing & Ethereal", "IDM - Intelligent Dance Music", "Breakbeat - Broken Rhythms", "Synthwave - Retro '80s", "Vaporwave - Nostalgia & Echo",
            "Cyberpunk - Dystopian", "Industrial - Mechanical & Noise", "EBM - Electronic Body Music", "Goth Industrial - Dark & Rhythmic", "Aggrotech - Extreme Electronic",
            "Hardcore EDM - Fast and Loud", "Speedcore - Fastest BPM", "Gabber - Dutch Hardcore", "Acid House - Acid Tones", "Tech House - Rhythmic Grooves",
            "Deep House - Depth and Atmosphere", "Lo-Fi Hip Hop - Relaxing & Dirty", "Boom Bap - Classic Hip Hop", "Mumble Rap - Contemporary Flow", "Conscious Hip Hop - Social Theme",
            "Emo Rap - Melancholy & Pain", "Cloud Rap - Dreamy & Atmospheric", "Neo-Soul - Modern R&B", "Pop - Mainstream & Catchy", "Electropop - Electronic Pop",
            "Indie Pop - Fresh & Alternative", "Hyperpop - Extreme & Experimental", "K-Pop - Colorful & Synchronized", "J-Pop - Energetic & Cute", "Art Pop - Complex Art",
            "Alternative Rock - '90s Sound", "Indie Rock - Garage Sound", "Post-Punk - Dark & Rhythmic", "Shoegaze - Noise & Melody", "Math Rock - Complex Rhythms",
            "Post-Rock - Instrumental Layering", "Death Metal - Extreme Vocals", "Black Metal - Dark & Cold", "Thrash Metal - Fast Riffs", "Metalcore - Melody & Breakdowns",
            "Djent - Rhythmic Complexity", "Stoner Metal - Thick & Psychedelic", "Doom Metal - Slow & Heavy", "Gothic Metal - Atmosphere & Female Vocals", "Nu Metal - Rap/Metal Hybrid",
            "Progressive Metal - Virtuosity", "Funk Metal - Groovy", "Symphonic Metal - Orchestral", "Power Metal - Epic Stories", "Pop Punk - Fast & Cheerful",
            "Emo - Emotional & Guitars", "Ska Punk - Rhythmic & Fast", "Hardcore Punk - Aggressive & Short", "Experimental - Unclassified", "Noise Music - Sound Chaos",
            "Vocal Trance - Female Vocals", "Liquid Drum & Bass - Melodic DnB", "Neurofunk - Dark & Complex DnB", "Techno - Acid", "Deep Techno - Minimalist Rhythm",
            "Afro House - African Rhythms", "Jungle - Fast Breakbeats", "Footwork/Juke - Chicago Rhythms", "Reggaeton - Latin Urban", "Dancehall - Jamaican Rhythms",
            "Gospel Rap - Spiritual Hip Hop", "Political Hip Hop - Protest Lyrics", "Crunk - Southern Rap", "Dirty South - Atlanta Rap", "West Coast Rap - G-Funk",
            "East Coast Rap - Complex Lyrics", "Marrakech Techno - Oriental", "Future Garage - Atmospheric", "Garage - UK Sound", "Speed Garage - Fast",
            "2-Step - Rhythmic UK", "Bleep Techno - '90s Sound", "Darkwave - Dark Synthetic", "Coldwave - Cold Atmosphere", "New Wave - '80s Synth",
            "Post-Metal - Atmospheric Metal", "Sludge Metal - Slow & Dirty", "Grindcore - Extreme & Short", "Crust Punk - Political Punk", "Screamo - Emotional Screams",
            "No Wave - Experimental Rock", "Alternative Hip Hop - Experimental Rap", "Jazzy Hip Hop - Jazz Samples", "Trip Hop - Slow & Atmospheric", "Chillwave - Relaxing",
            "Vocal Jazz - Singing", "Electro Swing - Retro & Dance", "Future Jazz - Experimental Jazz", "Tango Nuevo - Modern Tango", "Neoclassical - Modern Classical",
            "Minimalism - Repeating Motifs", "Sound Art - Sound Art", "Ambient Industrial - Dark Textures", "Dungeon Synth - Fantasy Atmosphere", "Chiptune - 8-bit Sound",
            "Bitpop - 8-bit Pop", "Vapor Soul - Slow R&B", "Witch House - Dark & Slow", "Seapunk - Water & '90s", "PC Music - Extreme Pop",
            "Breakcore - Chaotically Rhythmic", "Digital Hardcore - Fast & Noisy", "Terrorcore - Aggressive", "Frenchcore - French Hardcore", "Jumpstyle - Belgian Hardcore",
            "Hard Bass - Russian Bass", "Miami Bass - '80s Electro", "Jersey Club - Bounce Rhythm", "Baltimore Club - Fast Tempo", "UK Funky - African Rhythms",
            "Ghetto Tech - Detroit House/Techno", "Electroclash - '80s Electro", "Italo Disco - Italian Synth", "New Beat - Belgian Tempo", "Hypnagogic Pop - Dreamy Pop",
            "Chillout - Slow Tempo", "Exotica - Exotic Sounds", "Spoken Word - Spoken Word", "Poetry Slam - Rhythmic Poetry", "Avant-Garde - Innovation",
            "Post-Hardcore - Extreme Rock", "Screamo Revival - Modern Screams", "Folk Punk - Acoustic Punk", "Skate Punk - Fast California", "Pop Rock - Radio Rock",
            "Soft Rock - Gentle Rock", "Glam Metal - Hair Rock", "Stoner Rock - Slow Guitars", "Space Rock - Psychedelic", "Desert Rock - Desert Riffs",
            "Doom Metal (Funeral) - Slowest", "Symphonic Black Metal - Orchestral Black", "Industrial Metal - Metal & Noise", "Groove Metal - Rhythmic Thrash", "Melodic Death Metal - Melodic Death",
            "Crossover Thrash - Thrash/Punk", "Sludgecore - Slow Hardcore", "Powerviolence - Extremely Short", "Neofolk - Dark Acoustic", "Drone - Sustained Tones",
            "Noise Pop - Noisy Pop", "Dream Pop - Dreamy Pop", "Twee Pop - Cute Pop", "Chamber Pop - Chamber Pop", "Baroque Pop - Complex Pop",
            "Alternative R&B - Experimental R&B", "PBR&B - Contemporary R&B", "New Jack Swing - '90s R&B", "UK Hip Hop - British Rap", "Aussie Hip Hop - Australian Scene",
            "Nordic Pop - Scandinavian Pop", "J-Rock - Japanese Rock", "Korean Indie - Korean Indie", "Latin Trap - Latin Trap", "Cumbia Electrónica - Electronic Cumbia",
            "Future Pop - Modern Pop", "Tropical House - Summer Electronic", "Moombahton - Reggaeton & House", "Zouk Bass - Slow Bass", "Hardwave - Slow Atmosphere",
            "Wave - Dark Electronic"
        ];
        
        // --- 2. UTILITY FUNCTIONS ---
        
        /**
         * Copies text to the clipboard and shows a temporary confirmation tooltip.
         * @param {string} textToCopy 
         */
        function copyToClipboard(textToCopy) {
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = textToCopy;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            // Use execCommand for compatibility in iframe environments
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showConfirmationTooltip();
                } else {
                    console.error('Copy command failed.');
                }
            } catch (err) {
                console.error('Error executing copy command:', err);
            }
            document.body.removeChild(tempTextarea);
        }

        /**
         * Shows the copy confirmation tooltip briefly.
         */
        function showConfirmationTooltip() {
            const tooltip = document.getElementById('copy-confirmation');
            tooltip.style.opacity = '1';
            setTimeout(() => {
                tooltip.style.opacity = '0';
            }, 1500);
        }

        /**
         * Copies the full generated lyric text to the clipboard.
         */
        function copyResult() {
            const resultContainer = document.getElementById('result-container');
            const text = resultContainer.textContent.trim();
            if (text && !text.includes('Your generated lyric will appear here') && !text.includes('Error:')) {
                copyToClipboard(text);
            }
        }

        // --- 3. UI INITIALIZATION AND EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            const selectElement = document.getElementById('genre-select');
            const listDisplayElement = document.getElementById('genre-list-display');
            const generateButton = document.getElementById('generate-button');
            const topicInput = document.getElementById('topic-input');
            const copyButton = document.getElementById('copy-button'); 

            // Populate Select and Tag list
            genres.forEach(genre => {
                // For Select
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                selectElement.appendChild(option);

                // For Display List Tags
                const tag = document.createElement('span');
                tag.textContent = genre;
                tag.className = 'px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full font-medium text-xs whitespace-nowrap shadow-sm hover:bg-indigo-200 transition duration-150 cursor-pointer';
                
                // Add click listener to copy tag content
                tag.onclick = function() {
                    const tagName = this.textContent;
                    copyToClipboard(tagName);
                };
                
                listDisplayElement.appendChild(tag);
            });

            // Enable button after genre is selected and topic is entered
            const checkFormValidity = () => {
                const isGenreSelected = selectElement.value !== "";
                const isTopicEntered = topicInput.value.trim().length > 0;
                generateButton.disabled = !(isGenreSelected && isTopicEntered);
            };

            selectElement.addEventListener('change', checkFormValidity);
            topicInput.addEventListener('input', checkFormValidity);

            // Hide copy button initially
            copyButton.classList.add('hidden');
        });

        // --- 4. API CALL FUNCTION ---

        /**
         * Function to fetch the song lyric from Gemini AI.
         */
        async function generateLyrics() {
            const selectElement = document.getElementById('genre-select');
            const topicInput = document.getElementById('topic-input');
            const resultContainer = document.getElementById('result-container');
            const generateButton = document.getElementById('generate-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const buttonText = document.getElementById('button-text');
            const sendIcon = document.getElementById('send-icon');
            const sourceContainer = document.getElementById('source-container');
            const sourceList = document.getElementById('source-list');
            const copyButton = document.getElementById('copy-button');

            const selectedGenre = selectElement.value;
            const topicAndLanguage = topicInput.value.trim();

            if (!selectedGenre || !topicAndLanguage) {
                resultContainer.innerHTML = '<p class="text-red-400 font-bold">Please select a genre and enter the topic/language of the song.</p>';
                return;
            }

            // Set UI to loading state
            generateButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            sendIcon.classList.add('hidden');
            buttonText.textContent = 'Generating... Please wait.';
            resultContainer.innerHTML = `
                <div class="text-center py-10">
                    <div class="loading-spinner w-8 h-8 border-4 border-t-4 mx-auto rounded-full mb-3"></div>
                    <p class="text-indigo-400">AI is writing your ${selectedGenre} lyric...</p>
                </div>
            `;
            copyButton.classList.add('hidden'); 
            sourceContainer.classList.add('hidden');
            sourceList.innerHTML = '';

            // System instruction for long, detailed structure
            const systemPrompt = `
                You are a professional lyricist and music producer. Your task is to write an extremely long and complete song lyric that is strictly consistent with the genre and style provided.
                Genre: "${selectedGenre}".
                The text must be highly aggressive, energetic, and convey a "bass boosted" feeling, if appropriate for the genre (including Electro, Electronic, Hardstyle, etc.).
                
                **STRUCTURE:** You must use this detailed lyric structure and clearly label each section with the name in parentheses, e.g., (INTRO). The lyric must be long!
                (INTRO)
                (VERSE 1) - Long stanza
                (PRE-CHORUS)
                (CHORUS) - Extremely catchy, repeating refrain
                (VERSE 2) - Long stanza, developing the theme
                (VERSE 3) - New stanza, with a new perspective
                (PRE-CHORUS 2)
                (CHORUS) - Repeated, energetic refrain
                (BRIDGE) - The tone must be more intense or changed to serve as a climax
                (OUTRO) - Gradual fade-out and conclusion.
                
                **IMPORTANT RULE:** Create a clean, unformatted plain text output. DO NOT USE any formatting tags like ** (bold), * (italics), # (headings) or other Markdown syntax. The text must be ready for copying.
                **LANGUAGE:** Use the language specified in the user request.
            `;

            const userQuery = `
                Write a song lyric in the genre: ${selectedGenre}.
                Topic and language requirement: ${topicAndLanguage}.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Use Google Search for fact-grounding if the user provides a topic requiring current info
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey 
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Rate limit
                            throw new Error('Rate limit exceeded. Retrying...');
                        }
                        throw new Error(`HTTP Error! Status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        resultContainer.textContent = text; 
                        copyButton.classList.remove('hidden'); // Show copy button on success
                        
                        // Process sources
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        if (sources.length > 0) {
                            sources.forEach(source => {
                                const li = document.createElement('li');
                                const a = document.createElement('a');
                                a.href = source.uri;
                                a.target = "_blank";
                                a.className = "text-blue-400 hover:text-blue-300 underline";
                                a.textContent = `${source.title} (${new URL(source.uri).hostname})`;
                                li.appendChild(a);
                                sourceList.appendChild(li);
                            });
                            sourceContainer.classList.remove('hidden');
                        } else {
                            sourceContainer.classList.add('hidden');
                        }

                    } else {
                        resultContainer.textContent = 'An error occurred while generating the lyric. AI returned no content.';
                        copyButton.classList.add('hidden');
                    }
                    
                    // Success, break the loop
                    break; 

                } catch (error) {
                    console.error(`Error on attempt ${attempt + 1}:`, error.message);
                    attempt++;
                    if (attempt < maxRetries) {
                        // Exponential backoff
                        const delay = Math.pow(2, attempt) * 1000;
                        console.log(`Retrying attempt in ${delay / 1000} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Final attempt failed - check for "Failed to fetch" (network/security) vs API status errors
                        const errorMsg = error.message.includes('Failed to fetch') 
                            ? `Network/Security Error: The browser could not connect to the API server. Please check your internet connection or browser security settings.` 
                            : `API Error: ${error.message}`;

                        resultContainer.innerHTML = `<p class="text-red-400 font-bold">ERROR: Failed to retrieve lyric after ${maxRetries} attempts.</p><p class="text-gray-400">${errorMsg}</p>`;
                        copyButton.classList.add('hidden');
                    }
                }
            }

            // Reset UI state
            loadingSpinner.classList.add('hidden');
            sendIcon.classList.remove('hidden');
            buttonText.textContent = 'Generate Lyric'; 
            generateButton.disabled = false; // Re-enable button
        }
    </script>

</body>
</html>
